==================================================
==================================================
Setting up xTER Virtual Machine (VM) in VirtualBox
==================================================
==================================================


Prerequisites
=============

1. A 64-bit CPU (mostly x86-64, Intel or AMD); for other variants of 64-bit CPU possible, see support page of VirtualBox.
2. 5G or more of free unused RAM (normally it means 8G or more of total RAM; 6G total RAM will sometimes be enough, too).
3. Static IP4 on your router to Internet.


Pre-installation
================

1. Check that Virtualization support is enabled in your BIOS.
2. Check that Hyper-V native Windows virtualization is NOT running. If it is, stop it and maybe remove it.


Installation
============

1. Download the latest VirtualBox for your OS from https://www.virtualbox.org/wiki/Downloads
2. Run the installation binary and install VirtualBox to its default Windows location:"C:\Program Files\Oracle\VirtualBox"

In case you're on a different OS like Linux, the rest is the same for you, too. Here is a shortcut of all the commands in one script for you:
https://github.com/kl3eo/room-house/blob/main/VM_create_RH_only.sh

Setup xTER VM
=============

Open command line terminal - it usually prompts to "C:\Users\Bob" - if you're a User named Bob.

Type or copy/paste this command to set a correct PATH to the VirtualBox binary files:
set PATH=%PATH%;"C:\Program Files\Oracle\VirtualBox"

Now, check that Windows understands the "VBoxManage" command - type "VBoxManage" in the terminal and see the output.

If Windows doesn't understand this command, check this link to see why:
https://www.roelpeters.be/vboxmanage-is-not-recognized-and-how-to-solve-it/

If you have installed VirtualBox to a different folder, don't forget to set a correct PATH in the terminal before running the rest of this setup.

If Windows understands the "VBoxManage" command, and there is some old VM named "xTER", now you may want to delete it:
VBoxManage unregistervm xTER --delete

If there is no folder "C:\Users\Bob\VMs", now you should make one:
mkdir "C:\Users\Bob\VMs"

Change to this new directory:

cd "C:\Users\Bob\VMs"

Create a new VM named "xTER" of type "Linux Red Hat 64-bit":

1. VBoxManage createvm --name xTER --ostype RedHat_64 --register --basefolder "C:\Users\Bob\VMs"

Now there must have appeared a new folder - "C:\Users\Bob\VMs\xTER".

Provide your new VM with minimum 5,120M of RAM, 1 or 2 CPU cores, no audio, with EFI, port forwarding and logging external request IPs.
If you can, increase the RAM size and # of CPU cores according to what is actually there on your host computer:

2. VBoxManage modifyvm xTER --memory 5120 --cpus 2 --audio none --firmware efi --nic1 nat --nataliasmode1 proxyonly

Setup internal host-to-guest port forwarding for the Room-House chat and to the HTTPS admin web interface:

3. VBoxManage modifyvm xTER --natpf1 "chat,tcp,,8443,,443" 
4. VBoxManage modifyvm xTER --natpf1 "admin,tcp,,8843,,8443"

Create a 2Gb disk for Room-House database, logs, etc:

5. VBoxManage createmedium --filename 2G.vdi --size 2000

Create a virtual SATA controller:

6. VBoxManage storagectl xTER --name SATA --add sata

Download our bootloader file "https://github.com/kl3eo/room-house/blob/main/loop.vdi" and put it to "C:\Users\Bob\VMs\xTER"

Attach this file to the VM as Disk 0:

7. VBoxManage storageattach xTER --storagectl SATA --medium loop.vdi --port 0 --type hdd

Attach the 2Gb file as Disk 1:

8. VBoxManage storageattach xTER --storagectl SATA --medium 2G.vdi --port 1 --type hdd

Add this directive to boot from Disk 0:

9. VBoxManage modifyvm xTER --boot1 disk --boot2 none --boot3 none --boot4 none


Boot and post-installation setup
================================

Now, boot the VM from VirtualBox graphical manager. You should see another window opening and xTER loading in it. 
After the xTER is fully loaded, you'll see a confirmation in this window.

== OR =================
If there is no graphical manager, like when you've done this setup on a remote host, continue to use command line.

Start the xTER boot from it with the command:
10. VBoxHeadless --startvm xTER

Warning: You will NOT see any output from the loading xTER in this case. 

Just wait a few minutes and check if you can open the admin web interface (see below).
--------------------------------------------------------------------------------------

Suppose your computer has an internal IP as such: 192.168.0.11
Now, check if you can open the admin web interface in your browser at https://192.168.0.11:8843

[ The rest of this setup is covered in Help at https://xter.tech/vbhelp/index.html - go to p.17 and to the end ]

If your browser complains now that this site's certificate is "*.xter.tech" or "*.room-house.com", while you're trying to access it by IP - that's correct. 

We will allow your computer be accessed on the right URL later, and this certificate will then be good for your new Room-House node.

Use the default login/password, if it is the first time you log in the web interface.

When logged in, go to the Settings menu and enter some unique Host name for you node by which it will be known to public. 
We suggest using your city or location as the name.

When you changed the host name from default random numbers to some new name, hit "Enter" and then don't forget to push the "Save" button in the right column.

Don't forget to change the default admin password and also "Save" it. See the Help file on the link given above about how you can do this. 


Check your Room-House node is usable
====================================

First, look at the admin WI page menu "Info", Disk Use and Memory Use columns. If you've setup the VM with a minimal amount of RAM available to it,
that is, 5,120M, then you'd be now with ~195K of free disk space and 5,060M of total memory. Check that this is indeed the case. 

If you'd allowed more RAM during setup, then of course there would be more disk space and mem available now.

Now, look at the list of running processes in the same page below the middle line inside a wide container. Check that the KMS is running.
The must be a line ending with "/home/nobody/newlib/bin/kurento-media-server". That's it, the first line on top. So far, so good.

Now, look at the bottom of the same container, there must be a very long line containing a lot of words "java", "spring", "guava", etc.
If it's there, congratulations, your node is running. 

If it's not there, the chances are high that the node has not started automatically after the boot.

This is known to happen if your VM setup is minimal in RAM, or if the VM's CPU power is not high.
 
In this case, go to the "Stats" menu and hit the "Restart" button on top of the list. Wait a couple of seconds, then check the "Info" menu again.
Your node must be running now.

Yet you may see that your RH node is not running, and instead you see an alert telling you that there has been a problem with your static IP.
This happens if your external IP is dynamic, or if it's not visible from outside of your local net.

Check that your external IP is actually static and not dynamic - contact your internet provider and request for a static IP.

It is not possible to run an RH node on a dynamic IP, though it is possible to boot and use the admin web interface.

Your RH node will also temporarily stop running, if your external static IP becomes invisible from the outside. When this problem disappears,
so does the problem with the RH node - it's up and running again, automatically.

Now that your RH node is up and running, proceed to going public.

Going public
============

It's time to make your node visible to the world and begin to earn your coins for the Room-House traffic.

First, write to us and tell us what name you've chosen for your public node, and what's your static IP.
Example: name "aspen", IP 81.13.45.90

We need this info to add your node to our proxy servers so that it becomes visible to public.

Second, make port forwarding from your router to your host, namely, our standard external port for Room-House which is 443. 
You have to forward port 443 from your router to port 8443 of your host machine, which we guessed earlier has an IP like 192.168.0.11

Third, forward port 8443 from your router to port 8843 of your host.
But make sure that you've changed the default admin password as we hope you already did! Only you must know it by now.

Good luck!


