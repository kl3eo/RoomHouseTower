=============================
============================
Как запустить узел Validator
============================
=============================


Необходимые условия
===================


1. 64-bit CPU (архитектуры x86-64, Intel или AMD); о поддержке других процессоров см. на сайте VirtualBox.
2. 2G или более свободной оперативной памяти (RAM).
3. Статический IP4 на выходе в Интернет.


Перед установкой
================


1. Убедитесь, что в BIOS включена поддержка Virtualization.
2. Hyper-V (Windows) не должен быть запущен.


Установка
=========


1. Скачайте последнюю версию VirtualBox для своей операционной системы с сайта Oracle - см. https://www.virtualbox.org/wiki/Downloads
2. Установите VirtualBox в папку Windows по умолчанию:"C:\Program Files\Oracle\VirtualBox"


===== linux
Если вы работаете в Linux, описанный здесь метод установки подходит и для вас. 

Создайте обычного Linux-пользователя (только не "root"!), который будет работать с виртуальной машиной, или используйте для этого аккаунт "nobody". 

Тогда все перечисленные ниже команды можно выполнить одним bash-скриптом как указанный выше пользователь:

============================================================= start Linux script

#!/bin/bash
mkdir -p ~/VB && cd ~/VB

if [ -f /opt/loop_polka.vdi ]; then
        cp -a /opt/loop_polka.vdi ./
else
        echo File /opt/loop_polka.vdi not found. Exiting
        exit
fi

vboxmanage createvm --name xTER_polka --ostype RedHat_64 --register --basefolder `pwd`
mv loop_polka.vdi xTER_polka/ && cd xTER_polka
vboxmanage modifyvm xTER_polka --memory 2048 --cpus 2 --audio none --firmware efi --nic1 nat --nataliasmode1 proxyonly
vboxmanage modifyvm xTER_polka --natpf1 "admin,tcp,,8453,,443"
vboxmanage createmedium --filename 10G.vdi --size 10000
vboxmanage storagectl xTER_polka --name SATA --add sata
vboxmanage storageattach xTER_polka --storagectl SATA --medium loop_polka.vdi --port 0 --type hdd
vboxmanage storageattach xTER_polka --storagectl SATA --medium 10G.vdi --port 1 --type hdd
vboxmanage modifyvm xTER_polka --boot1 disk --boot2 none --boot3 none --boot4 none

============================================================= end Linux script
===== end linux

Создание виртуальной машины xTER
================================


Откройте окно командной строки (терминал) - она обычно начинается с "C:\Users\Bob" - если вы Windows-пользователь "Bob".

Установите переменную окружения PATH для нахождения VirtualBox системой:


set PATH=%PATH%;"C:\Program Files\Oracle\VirtualBox"


Сразу же проверьте, что Windows понимает команду "VBoxManage"  - напечатайте "VBoxManage" в окне терминала и нажмите Enter.

Если Windows не понимает эту команду, можно прочитать о причине:


https://www.roelpeters.be/vboxmanage-is-not-recognized-and-how-to-solve-it/


Если вы установили VirtualBox в другой папке, не забудьте указать правильный путь PATH в терминале, прежде чем выполнять дальнейшие действия.


Если Windows понимает команду "VBoxManage", и если уже есть старая виртуальная машина (VM) с названием "xTER_polka", можете сейчас удалить её следующей командой:


VBoxManage unregistervm xTER_polka --delete


Если пока что нет папки "C:\Users\Bob\VMs", пришло время создать её командой:


mkdir "C:\Users\Bob\VMs"


Создаём новую виртуальную машину "xTER_polka" типа "Linux Red Hat 64-bit" командой:


1. VBoxManage createvm --name xTER_polka --ostype RedHat_64 --register --basefolder "C:\Users\Bob\VMs"


Должна появиться новая папка - "C:\Users\Bob\VMs\xTER_polka". Перейдём в эту папку:


cd "C:\Users\Bob\VMs\xTER_polka"


Сейчас укажем, что для новой VM должны быть как минимум 2048 мегабайт оперативки (2 гиг), 1 или 2 CPU, без audio, с загрузкой EFI, port forwarding и logging external IPs.
Если можете, увеличьте RAM и количество ядер CPU у виртуалки согласно тому, что на самом деле есть у вашего компа:


2. VBoxManage modifyvm xTER_polka --memory 2048 --cpus 2 --audio none --firmware efi --nic1 nat --nataliasmode1 proxyonly


Пробросьте один порт 8453 с хоста до веб-интерфейса виртуалки (HTTPS) командой:


3. VBoxManage modifyvm xTER_polka --natpf1 "admin,tcp,,8453,,443" 


Создайте виртуальный VDI-диск по меньшей мере размером в 10Гб для блокчейна, системных логов, и т.п - или больше, если можете.  
Блокчейн растет примерно на 4Гб каждый месяц, поэтому сейчас при создании VM позаботьтесь о том, чтобы для него было выделено достаточно места. 

На середину августа 2021 г. размер блокчейна уже ~3 гига. Можете сами т.о. указать "size" 30000 или 60000 и т.д.

Создаваемый виртуальный диск будет назван как файл "10G.vdi" и лежать в той же папке "C:\Users\Bob\VMs\xTER_polka". 

Обратите внимание, что его размер при создании не соответствует заданному - т.к. он будет расти по мере наполнения.

4. VBoxManage createmedium --filename 10G.vdi --size 10000


Создаём виртуальный SATA controller:


5. VBoxManage storagectl xTER_polka --name SATA --add sata


Скачайте файл загрузчика "https://github.com/kl3eo/room-house/blob/main/loop_polka.vdi" в папку "C:\Users\Bob\VMs\xTER_polka"

Передаём его виртуальной машине как Disk 0:


6. VBoxManage storageattach xTER_polka --storagectl SATA --medium loop_vdi.vdi --port 0 --type hdd


Присоединяем ранее созданный 10Гб (или 30Гб, 60Гб, ..) файл как Disk 1:


7. VBoxManage storageattach xTER_polka --storagectl SATA --medium 10G.vdi --port 1 --type hdd


Даём директиву загрузки виртуалки с нашего Disk 0:


8. VBoxManage modifyvm xTER_polka --boot1 disk --boot2 none --boot3 none --boot4 none



Загрузка и пост-инсталл
=======================


Запустим VM из окна графического менеджера VirtualBox. Появится новое окно, и xTER будет грузиться в нём - вы можете наблюдать за стадиями загрузки в течение 2-3 минут.                  
После загрузки выйдет подтверждение, что система готова к работе.

== ИЛИ =================
Если нет графического менеджера, как например, при установке на удалённом Linux-хосте, то используйте для запуска VM командную строку:

VBoxHeadless --startvm xTER_polka

NB: пользователь Linux в этом случае тот же, как и при создании виртуальной машины.

Предупреждение: в этом случае, вы не увидите ничего, что видно при запуске из граф. менеджера - просто подождите несколько минут.


-------------------------------------------------------------------------
Откройте веб-интерфейс админа в браузере по ссылке https://localhost:8453
-------------------------------------------------------------------------


[ Дальнейшие действия по работе с админ. интерфейсом и изменению пароля описаны здесь https://validate.guru/help/howto2.html. ]

Если браузер пожалуется на сертификат "*.room-house.com", это OK - вы заходите на localhost, а сертификат для хоста нашего домена room-house.com.

Используйте password по умолчанию для первого входа в админ. интерфейс (логин - "admin", а пароль по умолчанию см. на экране загрузки xTER или см. ссылку выше).

Не забудьте поменять пароли для admin и для WiFi (если WiFi "mudejar" вдруг рабочий - проверьте). Смотрите файл по ссылке, указанной выше, как это сделать.

NB: WiFi на виртуалке, созданной как описано выше, - не включится. 
Но если ставите xTER без виртуалки на старый ноутбук или др. bare-metal, где он есть - то скорее всего включится, мы для этого поработали.


==========
==========

Удачи!

==========
==========
